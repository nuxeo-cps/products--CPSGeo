<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
<a href='http://mapbuilder.sourceforge.net'>Community Map Builder</a> 10 Aug 2005 Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="ModelBase.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b><a href='http://mapbuilder.sourceforge.net'>Community Map Builder</a> 10 Aug 2005</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>ModelBase.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		No overview generated for 'ModelBase.js'<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="ModelBase.html">ModelBase</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">/*
License: LGPL as per: http://www.gnu.org/copyleft/lesser.html
$Id$
*/</span>

<span class="comment">/**
 * Base Model class to be inherited by all Model objects and provdes methods
 * and properties common to all models.
 * Stores the XML document as the .doc property of the model.
 * Inherits from the Listener class so all models are also listener objects that
 * can call registered listeners.
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@base</span> Listener
 * <span class="attrib">@author</span> Cameron Shorter
 * <span class="attrib">@param</span> model       Pointer to the model instance being created
 * <span class="attrib">@param</span> modelNode   The model's XML object node from the configuration document.
 * <span class="attrib">@param</span> parentModel The model object that this model belongs to.
 */</span>
<span class="reserved">function</span> ModelBase(model, modelNode, parentModel) {
<span class="comment">  // Inherit the Listener functions and parameters</span>
  var listener = new Listener(model);
<span class="comment">
  //models are loaded asynchronously by default; </span>
  model.async = true;   //change to false <span class="reserved">for</span> sync loading
  model.contentType = <span class="literal">"text/xml"</span>;

  model.modelNode = modelNode;
  var idAttr = modelNode.attributes.getNamedItem(<span class="literal">"id"</span>);
  <span class="reserved">if</span> (idAttr) {
    model.id = idAttr.nodeValue;
  } <span class="reserved">else</span> {
<span class="comment">    //auto generated unique ID assigned to this model</span>
    model.id = <span class="literal">"MbModel_"</span> + mbIds.getId();
  }
<span class="comment">
  //get the human readable title for the model</span>
  var titleNode = modelNode.selectSingleNode(<span class="literal">"mb:title"</span>);
  <span class="reserved">if</span> (titleNode) {
    model.title = titleNode.firstChild.nodeValue;
  } <span class="reserved">else</span> {
    model.title = model.id;
  }

  <span class="comment">/**
  * set the initial model URL in config.
  * the URL can also be passed in as a URL parameter by using the model ID 
  * as the parameter name (which takes precendence over the config file)
  **/</span>
  <span class="reserved">if</span> (window.cgiArgs[model.id]) {  
    model.url = window.cgiArgs[model.id];
  } <span class="reserved">else</span> <span class="reserved">if</span> (window[model.id]) {  
    model.url = window[model.id];
  } <span class="reserved">else</span> <span class="reserved">if</span> (modelNode.url) {  
    model.url = modelNode.url;
  } <span class="reserved">else</span> {
    var defaultModel = modelNode.selectSingleNode(<span class="literal">"mb:defaultModelUrl"</span>);
    <span class="reserved">if</span> (defaultModel) model.url = defaultModel.firstChild.nodeValue;
  }
<span class="comment">
  //set the method property</span>
  var method = modelNode.selectSingleNode(<span class="literal">"mb:method"</span>);
  <span class="reserved">if</span> (method) {
    model.method = method.firstChild.nodeValue;
  } <span class="reserved">else</span> {
    model.method = <span class="literal">"get"</span>;
  }
<span class="comment">
  //set the namespace property</span>
  var namespace = modelNode.selectSingleNode(<span class="literal">"mb:namespace"</span>);
  <span class="reserved">if</span> (namespace) {
    model.namespace = namespace.firstChild.nodeValue;
  }

  var templateAttr = modelNode.attributes.getNamedItem(<span class="literal">"template"</span>);
  <span class="reserved">if</span> (templateAttr) {
    model.template = (templateAttr.nodeValue==<span class="literal">"true"</span>)?true:false;
    model.modelNode.removeAttribute(<span class="literal">"template"</span>);
  }
<span class="comment">
  //get the xpath to select nodes from the parent doc</span>
  var nodeSelectXpath = modelNode.selectSingleNode(<span class="literal">"mb:nodeSelectXpath"</span>);
  <span class="reserved">if</span> (nodeSelectXpath) {
    model.nodeSelectXpath = nodeSelectXpath.firstChild.nodeValue;
  }

  <span class="comment">/**
   * Get the value of a node as selected by an XPath expression.1
   * <span class="attrib">@param</span> objRef Reference to this node.
   * <span class="attrib">@param</span> xpath XPath of the node to update.
   * <span class="attrib">@return</span> value of the node or null if XPath does not find a node.
   */</span>
  <span class="reserved">this</span>.getXpathValue=<span class="reserved">function</span>(objRef,xpath){
    node=objRef.doc.selectSingleNode(xpath);
    <span class="reserved">if</span>(node &amp;&amp; node.firstChild){
      <span class="reserved">return</span> node.firstChild.nodeValue;
    }<span class="reserved">else</span>{
      <span class="reserved">return</span> null;
    }
  }
  model.getXpathValue=<span class="reserved">this</span>.getXpathValue;

  <span class="comment">/**
   * Update the value of a node within this model's XML document.
   * Triggers a refresh event from the model.
   * <span class="attrib">@param</span> objRef Reference to this node.
   * <span class="attrib">@param</span> xpath Xpath of the node to update.
   * <span class="attrib">@param</span> value Node's new value.
   * <span class="attrib">@return</span> Returns false if Xpath does not find a node.
   */</span>
  <span class="reserved">this</span>.setXpathValue=<span class="reserved">function</span>(objRef,xpath,value){
    node=objRef.doc.selectSingleNode(xpath);
    <span class="reserved">if</span>(node){
      <span class="reserved">if</span>(node.firstChild){
        node.firstChild.nodeValue=value;
      }<span class="reserved">else</span>{
        dom=Sarissa.getDomDocument();
        v=dom.createTextNode(value);
        node.appendChild(v);
      }
      objRef.setParam(<span class="literal">"refresh"</span>);
      <span class="reserved">return</span> true;
    }<span class="reserved">else</span>{
      <span class="reserved">return</span> false;
    }
  }
  model.setXpathValue=<span class="reserved">this</span>.setXpathValue;

  <span class="comment">/**
   * Load a Model's document.  
   * This will only occur if the model.url property is set. 
   * Calling this method triggers several events:
   *   modelStatus - to indicate that the model state is changing
   *   newModel - to give widgetrs a chance to clear themselves before the doc is loaded
   *   loadModel - to indicate that the document is loaded successfully
   *   refresh - to indicate that widgets should be refreshed
   *
   * <span class="attrib">@param</span> modelRef Pointer to the model object being loaded.
   */</span>
  <span class="reserved">this</span>.loadModelDoc = <span class="reserved">function</span>(modelRef){
    modelRef.setParam(<span class="literal">"modelStatus"</span>,<span class="literal">"loading"</span>);

    modelRef.callListeners( <span class="literal">"newModel"</span> );
    <span class="reserved">if</span> (modelRef.url) {

      <span class="reserved">if</span> (modelRef.contentType == <span class="literal">"image"</span>) {
<span class="comment">        //image models are set as a DOM image object</span>
        modelRef.doc = new Image();
        modelRef.doc.src = modelRef.url;
<span class="comment">        //modelRef.doc.onload = callback //TBD: for when image is loaded</span>

      } <span class="reserved">else</span> {
<span class="comment">        //XML content type</span>

        var xmlHttp = Sarissa.getXmlHttpRequest();
        var sUri = modelRef.url;
        <span class="reserved">if</span> ( sUri.indexOf(<span class="literal">"http://"</span>)==0 ) {
          <span class="reserved">if</span> (modelRef.method == <span class="literal">"get"</span>) {
            sUri = getProxyPlusUrl(sUri);
          } <span class="reserved">else</span> {
            xmlHttp.setRequestHeader(<span class="literal">"content-type"</span>,modelRef.contentType);
            xmlHttp.setRequestHeader(<span class="literal">"serverUrl"</span>,sUri);
            sUri = config.proxyUrl;
          }
        }
        xmlHttp.open(modelRef.method, sUri, modelRef.async);
        
        xmlHttp.onreadystatechange = <span class="reserved">function</span>() {
          modelRef.setParam(<span class="literal">"modelStatus"</span>,xmlHttp.readyState);
          <span class="reserved">if</span> (xmlHttp.readyState==4) {
            <span class="reserved">if</span> (xmlHttp.status &gt;= 400) {   //http errors status start at 400
              alert(<span class="literal">"error loading document: "</span> + sUri + <span class="literal">" - "</span> + xmlHttp.statusText + <span class="literal">"-"</span> + xmlHttp.responseText );
              modelRef.setParam(<span class="literal">"modelStatus"</span>,-1);
              <span class="reserved">return</span>;
            } <span class="reserved">else</span> {
<span class="comment">              //alert(xmlHttp.getResponseHeader("Content-Type"));</span>
              <span class="reserved">if</span> ( null==xmlHttp.responseXML ) {
                alert( <span class="literal">"null XML response:"</span> + xmlHttp.responseText );
              } <span class="reserved">else</span> {
                modelRef.doc = xmlHttp.responseXML;
                <span class="reserved">if</span> (modelRef.doc.documentElement.nodeName.search(/exception/i)&gt;=0) {
                  modelRef.setParam(<span class="literal">"modelStatus"</span>,-1);
                  alert(<span class="literal">"Exception:"</span>+Sarissa.serialize(xmlHttp.responseText));
                }
              }
              modelRef.finishLoading();
            }
          }
        }

        xmlHttp.send(modelRef.postData);

        <span class="reserved">if</span> (!modelRef.async) {
          <span class="reserved">if</span> (xmlHttp.status &gt;= 400) {   //http errors status start at 400
            alert(<span class="literal">"error loading document: "</span> + sUri + <span class="literal">" - "</span> + xmlHttp.statusText + <span class="literal">"-"</span> + xmlHttp.responseText );
            <span class="reserved">this</span>.model.setParam(<span class="literal">"modelStatus"</span>,-1);
            <span class="reserved">return</span>;
          } <span class="reserved">else</span> {
<span class="comment">            //alert(xmlHttp.getResponseHeader("Content-Type"));</span>
            <span class="reserved">if</span> ( null==xmlHttp.responseXML ) alert( <span class="literal">"null XML response:"</span> + xmlHttp.responseText );
            modelRef.doc = xmlHttp.responseXML;
            modelRef.finishLoading();
          }
        }
<span class="comment">
        //modelRef.doc.validateOnParse=false;  //IE6 SP2 parsing bug</span>
      }
    } <span class="reserved">else</span> {
<span class="comment">      //no URL means this is a template model</span>
<span class="comment">      //alert("url parameter required for loadModelDoc");</span>
    }
  }
  model.loadModelDoc = <span class="reserved">this</span>.loadModelDoc;

  <span class="comment">/**
   * Common steps to be carried out after all manner of model loading
   * Called to set the namespace for XPath selections and call the loadModel
   * listeners.
   */</span>
  <span class="reserved">this</span>.finishLoading = <span class="reserved">function</span>() {
<span class="comment">    // the following two lines are needed for IE; set the namespace for selection</span>
    <span class="reserved">this</span>.doc.setProperty(<span class="literal">"SelectionLanguage"</span>, <span class="literal">"XPath"</span>);
    <span class="reserved">if</span> (<span class="reserved">this</span>.namespace) Sarissa.setXpathNamespaces(<span class="reserved">this</span>.doc, <span class="reserved">this</span>.namespace);
    <span class="reserved">this</span>.callListeners(<span class="literal">"loadModel"</span>);
  }
  model.finishLoading = <span class="reserved">this</span>.finishLoading;

  <span class="comment">/**
   * Load XML for a model from an httpPayload object
   * To update model data, use:&lt;br/&gt;
   * httpPayload=new Object();&lt;br/&gt;
   * httpPayload.url="url" or null. If set to null, all dependant widgets
   *   will be removed from the display.&lt;br/&gt;
   * httpPayload.httpMethod="post" or "get"&lt;br/&gt;
   * httpPayload.postData=XML or null&lt;br/&gt;
   * <span class="attrib">@param</span> modelRef    Pointer to the model object being loaded.
   * <span class="attrib">@param</span> httpPayload an object to fully specify the request to be made
   */</span>
  <span class="reserved">this</span>.newRequest = <span class="reserved">function</span>(modelRef, httpPayload){
    modelRef.url = httpPayload.url;
    <span class="reserved">if</span> (!modelRef.url){
      modelRef.doc=null;
    }
    modelRef.method = httpPayload.method;
    modelRef.postData = httpPayload.postData;
    modelRef.loadModelDoc(modelRef);
  }
  model.newRequest = <span class="reserved">this</span>.newRequest;

 <span class="comment">/**
   * save the model by posting it to the serializeUrl, which is defined as a 
   * property of config.
   * <span class="attrib">@param</span> objRef Pointer to this object.
   */</span>
  <span class="reserved">this</span>.saveModel = <span class="reserved">function</span>(objRef) {
    <span class="reserved">if</span> (config.serializeUrl) {
      var response = postLoad(config.serializeUrl, objRef.doc);
      response.setProperty(<span class="literal">"SelectionLanguage"</span>, <span class="literal">"XPath"</span>);
      Sarissa.setXpathNamespaces(response, <span class="literal">"xmlns:xlink='http://www.w3.org/1999/xlink'"</span>);
      var onlineResource = response.selectSingleNode(<span class="literal">"//OnlineResource"</span>);
      var fileUrl = onlineResource.attributes.getNamedItem(<span class="literal">"xlink:href"</span>).nodeValue;
      objRef.setParam(<span class="literal">"modelSaved"</span>, fileUrl);
    } <span class="reserved">else</span> {
      alert(<span class="literal">"serializeUrl must be specified in config to save a model"</span>);
    }
  }
  model.saveModel = <span class="reserved">this</span>.saveModel;

  <span class="comment">/**
   * Creates all mapbuilder JavaScript objects based on the Object nodes defined
   * in the configuration file.
   * A reference to the created model is stored as a property of the config.objects
   * property using the model's ID; you can always get a reference to a mapbuilder
   * object as: "config.objects.objectId"
   * <span class="attrib">@param</span> configNode The node from config for the model to be created
   */</span>
  <span class="reserved">this</span>.createObject = <span class="reserved">function</span>(configNode) {
    var objectType = configNode.nodeName;
    var evalStr = <span class="literal">"new "</span> + objectType + <span class="literal">"(configNode,this);"</span>;
    var newObject = eval( evalStr );
    <span class="reserved">if</span> ( newObject ) {
      config.objects[newObject.id] = newObject;
      <span class="reserved">return</span> newObject;
    } <span class="reserved">else</span> { 
      alert(<span class="literal">"error creating object:"</span> + objType);
    }
  }
  model.createObject = <span class="reserved">this</span>.createObject;

  <span class="comment">/**
   * Creates all the mapbuilder objects from the config file as selected by the
   * XPath value passed in.
   * <span class="attrib">@param</span> objectXpath The XPath for the set of nodes being created
   */</span>
  <span class="reserved">this</span>.loadObjects = <span class="reserved">function</span>(objectXpath) {
<span class="comment">    //loop through all nodes selected from config</span>
    var configObjects = <span class="reserved">this</span>.modelNode.selectNodes( objectXpath );
    <span class="reserved">for</span> (var i=0; i&lt;configObjects.length; i++ ) {
      <span class="reserved">this</span>.createObject( configObjects[i]);
    }
  }
  model.loadObjects = <span class="reserved">this</span>.loadObjects;

  <span class="comment">/**
   * Initialization of all javascript model, widget and tool objects for this model. 
   * Calling this method triggers an init event for this model.
   * <span class="attrib">@param</span> modelRef Pointer to this object.
   */</span>
  model.init = <span class="reserved">function</span>(modelRef) {
    modelRef.loadObjects(<span class="literal">"mb:widgets/*"</span>);
    modelRef.loadObjects(<span class="literal">"mb:tools/*"</span>);
    modelRef.loadObjects(<span class="literal">"mb:models/*"</span>);
    modelRef.callListeners(<span class="literal">"init"</span>);
  }

  <span class="comment">/**
   * Listener registered with the parent model to call refresh listeners when 
   * the model document is loaded
   * <span class="attrib">@param</span> modelRef Pointer to this object.
   */</span>
  model.refresh = <span class="reserved">function</span>(modelRef) {
    modelRef.callListeners(<span class="literal">"refresh"</span>);
  }
  model.addListener(<span class="literal">"loadModel"</span>,model.refresh, model);

  <span class="comment">/**
   * Listener registered with the parent model to remove the doc and url 
   * of child models whenever the parent is reloaded.
   * <span class="attrib">@param</span> modelRef Pointer to this object.
   */</span>
  model.clearModel = <span class="reserved">function</span>(modelRef) {
    modelRef.doc=null;
    modelRef.url=null;
  }
<span class="comment">
  //don't load in models and widgets if this is the config doc, </span>
<span class="comment">  //defer that to an explcit config.init() call in mapbuilder.js</span>
  <span class="reserved">if</span> (parentModel &amp;&amp; !model.template) {
    model.parentModel = parentModel;
    parentModel.addListener(<span class="literal">"loadModel"</span>,model.loadModelDoc, model);
    parentModel.addListener(<span class="literal">"newModel"</span>, model.clearModel, model);
    model.init(model);
  }

}
</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b><a href='http://mapbuilder.sourceforge.net'>Community Map Builder</a> 10 Aug 2005</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Wed Aug 10 14:31:26 2005</div>
</body>
</html>
